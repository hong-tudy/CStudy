## 동기화란(synchronization)

- 프로세스들 사이의 수행 시기를 맞추는 것을 의미
    - 실행 순서 제어
        - 프로세스를 올바른 순서대로 실행
    - 상호 배제
        - 동시에 접근해서는 안되는
- 동시다발적으로 실행되는 많은 프로세스는 서로 데이터를 주고받으며 협력하며 실행될 수 있음
    - 워드 프로세서
        - 사용자로부터 입력을 받는 프로세스
        - 입력한 내용의 맞춤법을 검사하는 프로세스
        - 입력한 내용을 화면에 출력해주는 프로세스
        - 위 프로세스들은 각기 다른 독립적인 프로세스이지만 공동의 목표를 위해 서로 협력하는 존재
- 마구 동시에 실행되는 것이 아니라 올바른 실행을 위해서는 동기화가 필수
    - 스레드도 동기화 대상

### 상호 배제를 위한 동기화

- 상호 배제(mutual exclusion)
    - 공유가 불가능한 자원의 동시 사용을 피하기 위해 사용하는 알고리즘

### 생산자와 소비자 문제

- 생산자와 소비자는 총합이란 데이터를 동시에 사용하는데 소비자가 생산자의작업이 끝나기도 전에 총합을 수정했고, 생산자가 소비자의 작업이 끝나기도 전에 총합을 수정했기 때문에 엉뚱한 결과가 발생\

### 공유 자원과 임계 구역

- 여러 프로세스나 스레드가 동시에 접근하거나 사용할 수 있는 자원
- 교재의 계좌 잔액 문제와 생산자 소비자 문제의 예시에서 동시에 실행되는 프로세스들은 전역 변수 ‘잔액’, ‘총합’이라는 공동의 자원을 두고 작업
    - 입출력 장치, 보조기억장치
- 임계구역(critical section)
    - 동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역
    - 두 개 이상의 프로세스가 임계 구역에 진입하고자 하면 둘 중 하나는 대기
- 레이스 컨디션(race condition)
    - 임계 구역은 두 개 이상의 프로세스가 동시에 실행되면 안 되는 영역이지만, 잘못된 실행으로 인해 여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하여 문제가 발생하는 경우
    - 레이스 컨디션이 발생하면 계좌 잔액 문제나 생산자와 소비자 문제처럼 데이터의 일관성이 깨지는
    문제가 발생합
- 상호 배제를 위한 동기화는 이와 같은 일이 발생하지 않도록 두 개 이상의 프로세스가 임계 구역에 동시에 접근하지 못하도록 관리하는 것을 의미
- 상호 배제를 위한 동기화를 위한 세 가지 원칙
    - 상호 배제 (mutual exclusion)
        - 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없음
    - 진행 (progress)
        - 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 함
    - 유한 대기 (bounded waiting)
        - 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 함
            - 임계 구역에 들어오기 위해 무한정 대기해서는 안 됨

## 동기화 기법

### 뮤텍스 락

- 뮤텍스 락은 동시에 접근해서는 안 되는 자원에 동시에 접근하지 않도록 만드는 도구, 다시 말해 상호 배제를 위한 동기화도구
- 임계 구역에 진입하는 프로세스는 ‘내가 지금 임계 구역에 있음’을 알리기 위해 뮤텍스 락을 이용해 임계 구역에 자물쇠를 걸어둘 수 있고, 다른 프로세스는 임계 구역이 잠겨 있다면 기다리고, 잠겨 있지 않다면 임계 구역에 진입 가능
- 단순한 형태
    - 자물쇠 역할
        - 프로세스들이 공유하는 전역 변수 Lock
    - 임계 구역을 잠그는 역할
        - acquire 함수
            - 프로세스가 임계 구역에 진입하기 전에 호출하는 함수
            - 임계 구역이 잠겨 있다면 임계 구역이 열릴 때까지 (lock이 false가 될 때까지) 임계 구역을 **반복**적으로 확인하고, 임계 구역이 열려 있다면 임계 구역을 잠그는(lock을 true로 바꾸는) 함수
            - 바쁜 대기(busy wait)
    - 임계 구역의 잠금을 해제하는 역할
        - release 함수
            - 임계 구역에서의 작업이 끝나고 호출하는 함수
            - 현재 잠긴 임계 구역을 열어주는（lock을 false로 바꾸는） 함수
    - 락을 획득할 수 없다면（임계 구역에 진입할 수 없다면） 무작정 기다리고,
    - 락을 획득할 수 있다면（임계 구역에 진입할 수 있다면） 임계 구역을 잠근 뒤 임계 구역에서의 작업을 진행하고,
    - 임계 구역에서 빠져나올 때엔 다시 임계 구역의 잠금을 해제함으로써 임계 구역을 보호
- C/C++, python 등의 일부 프로그래밍 언어에서는 사용자가 직접 acquire, release 함수를 구현하지 않도록 뮤텍스락 기능을 제공

### 세마포(semaphore)

- 공유자원이 여러 개 있는상황에서도 적용이 가능한 동기화 도구
- 공유 리소스에 접근할 수 있는 프로세스의 **최대 허용치만큼 동시에 사용자가 접근하여 사용 가능**
- 프로세스는 임계 구역 앞에서 멈춤 신호를 받으면 잠시 기다리고, 가도 좋다는 신호를 받으면 그제서야 임계 구역
- 이진 세마포
    - 카운터 값이 0 또는 1로만 유지되며, 이는 사실상 뮤텍스와 동일한 기능
- 카운팅 세마포
    - 카운터가 0 이상인 모든 값을 가질 수 있으며, 이를 통해 여러 스레드가 동시에 자원에 접근 가능
- 구현 형태
    - 전역 변수 S
        - 임계 구역에 진입할 수 있는 프로세스의 개수(사용 가능한 공유 자원의 개수)
    - wait 함수
        - 임계 구역에 들어가도 좋은지, 기다려야 할지 알려주는 함수
    - signal 함수
        - 임계 구역 앞에서 기다리는 프로세스에 신호를 주는 함수
    - 프로세스 Pl wait 호출. s는 현재 2이므로 S를 1 감소시키고 임계 구역 진입
    - 프로세스 P2 wait 호출. s는 현재 1이므로 S 를 1 감소시키고 임계 구역 진입
    - 프로세스 P3 wait 호출. S는 현재 0 이므로 무한히 반복하며 S 확인
    - 프로세스 P1 임계 구역 작업 *종료*, signal () 호출. S를 1 증가
    - 프로세스 P3 s가1이 됨을 확인. S는 현재 1이므로 S를 1 감소시키고 임계 구역 진입
- 사용할 수 있는 공유 자원이 없는 경우 프로세스는 무작정 무한히 반복하며 s를 확인해야 함
- 바쁜 대기를 반복할 때 CPU가 더 생산성 있는 작업을 못하고 CPU 주기를 낭비하는 점에서 손해
    - 실제로 더 좋은 방법 사용
    - wait 함수는 만일 사용할 수 있는 자원이 없을 경우 해당 프로세스 상태를 대기 상태로 만들고, 그 프로세스의 PCB를 세마포를 위한 대기 큐에 집어넣음
    다른 프로세스가 임계 구역에서의 작업이 끝나고 signal 함수를 호출하면 signal 함수는 대기 중인 프로세스를 대기 큐에서 제거하고, 프로세스 상태를 준비 상태로 변경한 뒤 준비 큐로 옮겨줌
- ‘특정 조건이 만족되어야만 실행할 수 있는 상황에서 올바른 순서대로 실행하게 하는 것’ 또한 동기화 (실행 순서 제어를 위한 동기화)
    - 세마포의 변수 S를 0으로 두고 먼저 실행할 프로세스 뒤에 signal 함수, 다음에 실행할 프로세스 앞에 wait 함수를 붙이면 됨
    - P1 이 먼저 실행되든 P2가 먼저 실행되든 반드시 Pl, P2 순서대로 실행

### 모니터

- 동시성 프로그래밍에서 상호 배제(Mutual Exclusion)를 제공하는 고수준의 추상화
- 세마포의 잘못된 사용 예시
    - 세마포를 누락한 경우
    - watit과 signal 순서를 헷갈린 경우
    - wait과 signal을 중복해서 사용한 경우
- 모니터는 공유 자원과 공유 자원에 접근하기 위한 인터페이스(통로)를 묶어 관리
- 공유 자원에 접근하고자 하는 프로세스를 큐에 삽입하고, 큐에 삽입된 순서대로 하나씩 공유 자원을 이용하도록 함
- 실행 순서 제어를 위한 동기화도 제공
    - 조건 변수(condition variable)
        - 프로세스나 스레드의 실행 순서를 제어하기 위해 사용하는 특별한 변수
- 모니터에 진입하기 위해 삽입되는 큐（상호 배제를 위한 큐）
    - 모니터에 한 번에 하나의 프로세스만 진입하도록 하기 위해 만들어진 큐
- wait가 호출되어 실행이 중단된 프로세스들이 삽입되는 큐（조건 변수에 대한 큐 )
    - 모니터에 이미 진입한 프로세스의 실행 조건이 만족될 때까지 잠시 실행이 중단되어 기다리기 위해 만들어진 큐입
- 프로세스 실행 순서 제어
    - 특정 프로세스가 아직 실행될 조건이 되지 않았을 때에는 wait를 통해 실행을 중단
    - 특정 프로세스가 실행될 조건이 충족되었을 때에는 signal을 통해 실행을 재개